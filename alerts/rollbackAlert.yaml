apiVersion: "nais.io/v1"
kind: "Alert"
metadata:
  name: babylon-alerter
  namespace: babylon
  labels:
    team: babylon
spec:
  route:
    group_by: [slack_channel]
  receivers: # receivers for all alerts below
    slack:
      channel: '\{{ index ((index .Alerts 0).Labels) "slack_channel" }}'
      icon_emoji: ':farmer:'
      send_resolved: false
      username: Babylon - Testing
  alerts:
    - alert: Feilende applikasjon håndtert
      expr: 'increase(babylon_deployment_rollbacks_total[5m]) > 1'
      for: 0s
      action: |
        Slå applikasjonen av og på igjen, utfør `rollback`,
        eller slett applikasjonen.

        Kan også være nyttig å:
        - Les app logs (kubectl logs appname).
        - Les Application events (kubectl describe deployment appname)

        Om du ønsker å motta disse meldingene i en annen kanal,
        kan du legge til en annen kanal i `platform-alerts-channel`-feltet i
        https://github.com/navikt/teams.
        Vi prioriterer også eksisterende kanaler brukt i en NAIS-alert i samme
        namespace, i alfabetisk rekkefølge.
      description: |
        Vi har detektert en feil i NAIS-deploymentet "\{{ $labels.deployment }}".
        \{{- if $labels.currentDockerHash }}
        Utfører `rollback` fra \{{ $labels.previousDockerHash }} til \{{ $labels.currentDockerHash }}.
        \{{- else }}
        Vi har nedskalert deploymentet til null replicas.
        \{{- end }}
      documentation: https://github.com/nais/babylon/README.md
      severity: warning
    - alert: Feilende applikasjon detektert
      expr: 'increase(babylon_team_notifications_total[5m]) > 1'
      for: 0s
      action: |
        Slå applikasjonen av og på igjen, utfør `rollback`,
        eller slett applikasjonen.

        Kan også være nyttig å:
        - Les app logs (kubectl logs appname).
        - Les Application events (kubectl describe deployment appname)

        Om du ønsker å motta disse meldingene i en annen kanal,
        kan du legge til en annen kanal i `platform-alerts-channel`-feltet i
        https://github.com/navikt/teams.
        Vi prioriterer også eksisterende kanaler brukt i en NAIS-alert i samme
        namespace, i alfabetisk rekkefølge.
      description: |
        Vi har detektert en feil i NAIS-deploymentet "\{{ $labels.deployment }}".
        Dersom dere ikke utfører endringer, så vil Babylon nedskalere applikasjonen
        tidligst "\{{ $labels.grace_cutoff }}".
      documentation: https://github.com/nais/babylon/README.md
      severity: warning
---
apiVersion: nais.io/v1
kind: Alert
metadata:
  name: babylon-down-alert
  namespace: babylon
  labels:
    team: babylon
spec:
  receivers:
    slack:
      channel: 'babylon-existential-alerts'
  alerts:
    - alert: applikasjon nede
      expr: kube_deployment_status_replicas_available{deployment="babylon"} == 0
      for: 2m
      description: "App {{ $labels.app }} er nede i namespace {{ $labels.kubernetes_namespace }}"
      action: "`kubectl describe pod {{ $labels.kubernetes_pod_name }} -n {{ $labels.kubernetes_namespace }}` for events, og `kubectl logs {{ $labels.kubernetes_pod_name }} -n {{ $labels.kubernetes_namespace }}` for logger"
    - alert: høy feilrate i logger
      expr: (100 * sum by (log_app, log_namespace) (rate(logd_messages_total{log_app="babylon",log_level=~"Warning|Error"}[3m])) / sum by (log_app, log_namespace) (rate(logd_messages_total{log_app="babylon"}[3m]))) > 10
      for: 3m
      action: "Sjekk loggene til app {{ $labels.log_app }} i namespace {{ $labels.log_namespace }}, for å se hvorfor det er så mye feil"
