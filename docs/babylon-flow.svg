<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="705px" preserveAspectRatio="none" style="width:857px;height:705px;background:#FFFFFF;" version="1.1" viewBox="0 0 857 705" width="857px" zoomAndPan="magnify"><defs><filter height="300%" id="f1e1fzujp5i4pt" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1e1fzujp5i4pt)" height="425.502" style="stroke:#000000;stroke-width:2.0;" width="763" x="77.5" y="178.1094"/><rect fill="#FFFFFF" filter="url(#f1e1fzujp5i4pt)" height="293.2598" style="stroke:#000000;stroke-width:2.0;" width="743" x="87.5" y="303.3516"/><rect fill="#FFFFFF" filter="url(#f1e1fzujp5i4pt)" height="149.5078" style="stroke:#000000;stroke-width:2.0;" width="723" x="97.5" y="338.5723"/><rect fill="#FFFFFF" height="73.5762" style="stroke:none;stroke-width:1.0;" width="723" x="97.5" y="414.5039"/><rect fill="#FFFFFF" height="57.2656" style="stroke:none;stroke-width:1.0;" width="743" x="87.5" y="495.0801"/><rect fill="#FFFFFF" height="44.2656" style="stroke:none;stroke-width:1.0;" width="743" x="87.5" y="552.3457"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="42" x2="42" y1="88.4883" y2="620.6113"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="181.5" x2="181.5" y1="88.4883" y2="620.6113"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="432" x2="432" y1="88.4883" y2="620.6113"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="783.5" x2="783.5" y1="88.4883" y2="620.6113"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="5" y="85.5352">developer</text><ellipse cx="42" cy="15" fill="#FEFECE" filter="url(#f1e1fzujp5i4pt)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M42,23 L42,50 M29,31 L55,31 M42,50 L29,65 M42,50 L55,65 " fill="none" filter="url(#f1e1fzujp5i4pt)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="5" y="633.1465">developer</text><ellipse cx="42" cy="646.0996" fill="#FEFECE" filter="url(#f1e1fzujp5i4pt)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M42,654.0996 L42,681.0996 M29,662.0996 L55,662.0996 M42,681.0996 L29,696.0996 M42,681.0996 L55,696.0996 " fill="none" filter="url(#f1e1fzujp5i4pt)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#f1e1fzujp5i4pt)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="145" x="107.5" y="36.5117"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="114.5" y="57.0469">Kubernetes Cluster</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="132" y="73.5352">(e.g. dev-gcp)</text><rect fill="#FEFECE" filter="url(#f1e1fzujp5i4pt)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="145" x="107.5" y="619.6113"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="114.5" y="640.1465">Kubernetes Cluster</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="132" y="656.6348">(e.g. dev-gcp)</text><rect fill="#FEFECE" filter="url(#f1e1fzujp5i4pt)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="68" x="396" y="53"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="403" y="73.5352">Babylon</text><rect fill="#FEFECE" filter="url(#f1e1fzujp5i4pt)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="68" x="396" y="619.6113"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="403" y="640.1465">Babylon</text><rect fill="#FEFECE" filter="url(#f1e1fzujp5i4pt)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="49" x="757.5" y="53"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35" x="764.5" y="73.5352">Slack</text><rect fill="#FEFECE" filter="url(#f1e1fzujp5i4pt)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="49" x="757.5" y="619.6113"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35" x="764.5" y="640.1465">Slack</text><rect fill="#EEEEEE" filter="url(#f1e1fzujp5i4pt)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="850.5" x="0" y="119.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="850.5" y1="119.1436" y2="119.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="850.5" y1="122.1436" y2="122.1436"/><rect fill="#EEEEEE" filter="url(#f1e1fzujp5i4pt)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="100" x="375.25" y="108.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="86" x="381.25" y="125.0566">Primary loop</text><polygon fill="#A80036" points="170,159.1094,180,163.1094,170,167.1094,174,163.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="42" x2="176" y1="163.1094" y2="163.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="49" y="158.3672">deploy application</text><path d="M77.5,178.1094 L151.5,178.1094 L151.5,185.1094 L141.5,195.1094 L77.5,195.1094 L77.5,178.1094 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="425.502" style="stroke:#000000;stroke-width:2.0;" width="763" x="77.5" y="178.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="92.5" y="191.6777">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="174" x="166.5" y="190.7441">[Repeats every X (default: 60s)]</text><polygon fill="#A80036" points="193,212.7305,183,216.7305,193,220.7305,189,216.7305" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="187" x2="431" y1="216.7305" y2="216.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="199" y="211.9883">GET "Deployments"</text><polygon fill="#A80036" points="420,242.041,430,246.041,420,250.041,424,246.041" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="182" x2="426" y1="246.041" y2="246.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="189" y="241.2988">Deployments</text><line style="stroke:#A80036;stroke-width:1.0;" x1="432" x2="474" y1="275.3516" y2="275.3516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="474" x2="474" y1="275.3516" y2="288.3516"/><line style="stroke:#A80036;stroke-width:1.0;" x1="433" x2="474" y1="288.3516" y2="288.3516"/><polygon fill="#A80036" points="443,284.3516,433,288.3516,443,292.3516,439,288.3516" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="338" x="439" y="270.6094">filter(deployment.namespace in allowed_namespaces)</text><path d="M87.5,303.3516 L149.5,303.3516 L149.5,310.3516 L139.5,320.3516 L87.5,320.3516 L87.5,303.3516 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="293.2598" style="stroke:#000000;stroke-width:2.0;" width="743" x="87.5" y="303.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="102.5" y="316.9199">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="332" x="164.5" y="315.9863">[deployment.annotations.Notification.age &gt; Y (default: 24h)</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="411" x="168.5" y="328.9414">and deployment.annotations.LastChangeCause != Rolled back by Babylon]</text><path d="M97.5,338.5723 L159.5,338.5723 L159.5,345.5723 L149.5,355.5723 L97.5,355.5723 L97.5,338.5723 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="149.5078" style="stroke:#000000;stroke-width:2.0;" width="723" x="97.5" y="338.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="112.5" y="352.1406">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="281" x="174.5" y="351.207">[exists running replicaset from previous revision]</text><polygon fill="#A80036" points="193,373.1934,183,377.1934,193,381.1934,189,377.1934" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="187" x2="431" y1="377.1934" y2="377.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="199" y="372.4512">rollback to working revision</text><polygon fill="#A80036" points="772,402.5039,782,406.5039,772,410.5039,776,406.5039" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="432" x2="778" y1="406.5039" y2="406.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="439" y="401.7617">rolled back deployment</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="97.5" x2="820.5" y1="415.5039" y2="415.5039"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="129" x="102.5" y="426.1387">[no rollback candidate]</text><polygon fill="#A80036" points="193,446.7695,183,450.7695,193,454.7695,189,450.7695" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="187" x2="431" y1="450.7695" y2="450.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="199" y="446.0273">downscale deployment to 0 replicas</text><polygon fill="#A80036" points="772,476.0801,782,480.0801,772,484.0801,776,480.0801" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="432" x2="778" y1="480.0801" y2="480.0801"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="439" y="475.3379">downscaled deployment</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="87.5" x2="830.5" y1="496.0801" y2="496.0801"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="198" x="92.5" y="506.7148">[deployment.age &lt; Z (default: 24h)]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="432" x2="474" y1="531.3457" y2="531.3457"/><line style="stroke:#A80036;stroke-width:1.0;" x1="474" x2="474" y1="531.3457" y2="544.3457"/><line style="stroke:#A80036;stroke-width:1.0;" x1="433" x2="474" y1="544.3457" y2="544.3457"/><polygon fill="#A80036" points="443,540.3457,433,544.3457,443,548.3457,439,544.3457" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="439" y="526.6035">skip</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="87.5" x2="830.5" y1="553.3457" y2="553.3457"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="119" x="92.5" y="563.9805">[deployment.age &gt; Z]</text><polygon fill="#A80036" points="772,584.6113,782,588.6113,772,592.6113,776,588.6113" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="432" x2="778" y1="588.6113" y2="588.6113"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="439" y="583.8691">alert team of failing deployment</text><!--MD5=[72e31e12f334d221e3f11015d5e060a2]
@startuml babylon-flow 
actor developer as developer
participant k8s as "Kubernetes Cluster\n(e.g. dev-gcp)"
participant babylon as "Babylon"
participant alertmanager as "Slack"
==Primary loop==
developer -> k8s: deploy application 
loop Repeats every X (default: 60s)
babylon -> k8s: GET "Deployments"
return Deployments
babylon -> babylon: filter(deployment.namespace in allowed_namespaces)

alt deployment.annotations.Notification.age > Y (default: 24h) \n and deployment.annotations.LastChangeCause != Rolled back by Babylon

    alt exists running replicaset from previous revision
        
        babylon -> k8s: rollback to working revision
        babylon -> alertmanager: rolled back deployment

    else no rollback candidate

        babylon -> k8s: downscale deployment to 0 replicas
        babylon -> alertmanager: downscaled deployment

    end

else deployment.age < Z (default: 24h)
    
    babylon -> babylon: skip

else deployment.age > Z

    babylon -> alertmanager: alert team of failing deployment
end

end
@enduml

PlantUML version 1.2021.9(Sun Jul 25 12:13:56 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: NO
--></g></svg>